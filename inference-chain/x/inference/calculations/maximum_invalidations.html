<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invalidation Throttling Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            max-width: 1000px;
            margin: auto;
            background-color: #f9f9f9;
            color: #222;
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1e1e1e;
                color: #eee;
            }
            input[type=range] {
                background-color: #333;
            }
        }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .control {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
        }
        input[type=range] {
            width: 100%;
        }
        .output {
            margin-top: 10px;
            font-size: 0.9em;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
<h1>Invalidation Throttling Simulator</h1>
<div class="controls">
    <div class="control">
        <label for="weight">Weight (W): <span id="weightVal">0.1</span></label>
        <input type="range" id="weight" min="0" max="1" step="0.01" value="0.1">
    </div>
    <div class="control">
        <label for="reputation">Reputation (R): <span id="reputationVal">50</span></label>
        <input type="range" id="reputation" min="0" max="100" step="1" value="50">
    </div>
    <div class="control">
        <label for="maxInferences">Max Inferences to Simulate (I): <span id="maxInferencesVal">1000</span></label>
        <input type="range" id="maxInferences" min="1" max="100" step="1" value="50">
    </div>
    <div class="control">
        <label for="maxParallel">Max Parallel Invalidations (M): <span id="maxParallelVal">500</span></label>
        <input type="range" id="maxParallel" min="10" max="10000" step="10" value="500">
    </div>
    <div class="control">
        <label for="curveFactor">Curve Factor (C): <span id="curveFactorVal">500</span></label>
        <input type="range" id="curveFactor" min="1" max="1000" step="1" value="500">
    </div>
    <div class="control">
        <label>Curve Type:</label>
        <label><input type="radio" name="curveType" value="tanh" checked> tanh</label>
        <label><input type="radio" name="curveType" value="logistic"> logistic</label>
    </div>
</div>

<canvas id="chart"></canvas>

<script>
    const weightSlider = document.getElementById("weight");
    const reputationSlider = document.getElementById("reputation");
    const maxInferencesSlider = document.getElementById("maxInferences");
    const maxParallelSlider = document.getElementById("maxParallel");
    const curveFactorSlider = document.getElementById("curveFactor");
    const curveTypeRadios = document.getElementsByName("curveType");

    const weightVal = document.getElementById("weightVal");
    const reputationVal = document.getElementById("reputationVal");
    const maxInferencesVal = document.getElementById("maxInferencesVal");
    const maxParallelVal = document.getElementById("maxParallelVal");
    const curveFactorVal = document.getElementById("curveFactorVal");

    function updateLabels() {
        weightVal.textContent = weightSlider.value;
        reputationVal.textContent = reputationSlider.value;
        const iMax = getMaxInferences();
        maxInferencesVal.textContent = iMax;
        maxParallelVal.textContent = maxParallelSlider.value;
        curveFactorVal.textContent = curveFactorSlider.value;
    }

    function getCurveType() {
        return Array.from(curveTypeRadios).find(r => r.checked).value;
    }

    function getMaxInferences() {
        // Logarithmic scaling: 10^slider value from 1 to 100
        const sliderVal = parseInt(maxInferencesSlider.value);
        return Math.floor(Math.pow(10, sliderVal / 25));
    }

    function calculateInvalidations(I, M, W, R, C, curveType) {
        let curveVal;
        if (curveType === "tanh") {
            curveVal = Math.tanh(I / C);
        } else {
            const k = 5 / C;
            curveVal = 1 / (1 + Math.exp(-k * (I - C)));
        }
        return Math.floor(Math.max(1, M * W * (R / 100) * curveVal));
    }

    const ctx = document.getElementById("chart").getContext("2d");
    const chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [{
                label: "Invalidations",
                data: [],
                borderWidth: 2,
                fill: false,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: { display: true, text: "Inferences (I)" }
                },
                y: {
                    title: { display: true, text: "Max Allowed Invalidations" },
                    beginAtZero: true
                }
            }
        }
    });

    function updateChart() {
        updateLabels();
        const M = parseFloat(maxParallelSlider.value);
        const W = parseFloat(weightSlider.value);
        const R = parseFloat(reputationSlider.value);
        const C = parseFloat(curveFactorSlider.value);
        const curveType = getCurveType();
        const maxI = getMaxInferences();

        const labels = [];
        const data = [];

        for (let I = 0; I <= maxI; I += Math.max(1, Math.floor(maxI / 100))) {
            labels.push(I);
            data.push(calculateInvalidations(I, M, W, R, C, curveType));
        }

        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
    }

    document.querySelectorAll("input").forEach(input => {
        input.addEventListener("input", updateChart);
    });

    updateChart();
</script>
</body>
</html>
